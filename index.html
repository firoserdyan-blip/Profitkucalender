<!doctype html>

<html lang="id" data-theme="light">
<head>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6266746973368170"
     crossorigin="anonymous"></script>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ProfitKu: Aplikasi Kalender Profit Trading Harian Gratis (Demo)</title>

<link rel="icon" type="image/png" href="logo.png" /> 
<link rel="manifest" href="manifest.json">

<meta property="og:url" content="https://firoserdyan-blip.github.io/" /> 
<meta property="og:title" content="ProfitKu: Kalender Profit Trading Harian Gratis" />
<meta property="og:description" content="Lupakan Excel yang rumit. Aplikasi web gratis untuk trader dan investor yang ingin melacak dan menganalisis performa profit dan kerugian harian dengan kalender interaktif. Tinjau performa trading Anda sekarang!" />
<meta property="og:image" content="https://firoserdyan-blip.github.io/logo.png" />


<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>

<style>
/* --- BASE STYLE & THEMING (LAMA) --- */
body { font-family: sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
:root {
    --bg-color: #f4f6f9; /* Light mode background */
    --text-color: #333; /* Light mode text */
    --primary-color: #007bff; /* Blue */
    --success-color: #28a745; /* Green */
    --danger-color: #dc3545; /* Red */
    --card-bg: #fff;
    --border-color: #ddd;
    --header-bg: #f8f9fa;
    --day-bg: #fff;
    --day-hover-bg: #e9ecef;
}
[data-theme="dark"] {
    --bg-color: #121212;
    --text-color: #e0e0e0;
    --primary-color: #4a90e2; 
    --success-color: #4CAF50;
    --danger-color: #f44336;
    --card-bg: #1e1e1e;
    --border-color: #333;
    --header-bg: #222;
    --day-bg: #1e1e1e;
    --day-hover-bg: #333;
}
.container { max-width: 900px; margin: 0 auto; padding: 20px 10px; }
.header { text-align: center; margin-bottom: 20px; background-color: var(--header-bg); padding: 15px 0; border-bottom: 1px solid var(--border-color); }
.header h1 { margin: 0; font-size: 1.8em; color: var(--primary-color); }
.calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; border: 1px solid var(--border-color); padding: 5px; border-radius: 8px; background-color: var(--card-bg); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.day-header { text-align: center; padding: 10px 0; font-weight: bold; background-color: var(--primary-color); color: white; border-radius: 4px 4px 0 0; }
.day { position: relative; min-height: 80px; padding: 8px; border: 1px solid var(--border-color); cursor: pointer; border-radius: 4px; background-color: var(--day-bg); transition: background-color 0.2s; }
.day:hover { background-color: var(--day-hover-bg); }
.day.empty { background-color: transparent; border: none; cursor: default; }
.day-number { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
.profit-indicator { font-size: 0.9em; margin-top: 5px; font-weight: 500; }
.profit { color: var(--success-color); }
.loss { color: var(--danger-color); }
.neutral { color: var(--text-color); opacity: 0.7; }
.nav-buttons { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.nav-buttons h2 { margin: 0; font-size: 1.5em; }
.btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
.btn-primary { background-color: var(--primary-color); color: white; }
.btn-primary:hover { background-color: #0056b3; }
.btn-danger { background-color: var(--danger-color); color: white; }
.btn-danger:hover { background-color: #c82333; }
.btn-secondary { background-color: #6c757d; color: white; }
.btn-secondary:hover { background-color: #5a6268; }
.btn-success { background-color: var(--success-color); color: white; }
.btn-success:hover { background-color: #1e7e34; }
.summary { background-color: var(--card-bg); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--border-color); }
.summary h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }

/* Modal Styling */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background-color: var(--card-bg); padding: 25px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
.modal-header h4 { margin: 0; color: var(--primary-color); }
.close-btn { font-size: 1.5em; font-weight: bold; cursor: pointer; border: none; background: none; color: var(--text-color); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--day-bg); color: var(--text-color); }
.modal-footer { margin-top: 20px; display: flex; justify-content: space-between; }

/* Responsive adjustments */
@media (max-width: 600px) {
    .calendar { grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .day { min-height: 60px; padding: 5px; }
    .day-number { font-size: 0.9em; }
    .profit-indicator { font-size: 0.75em; }
    .header h1 { font-size: 1.4em; }
}

/* --- PROFESIONAL STYLE REVISI --- */
.prof-header-alert { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-weight: bold; margin-bottom: 15px; border-radius: 4px; }
.auth-status { display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 5px; }
.auth-status .btn { padding: 5px 10px; }
.footer { text-align: center; padding: 20px 0; border-top: 1px solid var(--border-color); margin-top: 40px; }
.footer-text { font-size: 0.8em; margin-top: 10px; color: var(--text-color); opacity: 0.7; }

/* Theme Toggle */
.theme-toggle { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.5em; }

/* Profile/Logout Button */
#authInfo {
    margin: 0;
    font-weight: 600;
}
.prof-header-right {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}
</style>
</head>

<body>
<div class="container">
    
    <div class="prof-header-alert" id="authStatusAlert">
        Anda berada di **Mode Demo** (data tidak disimpan permanen). Silakan <a href="#" onclick="showLoginModal()" style="color: yellow; text-decoration: underline;">**LOGIN/DAFTAR**</a> untuk menyimpan data Anda!
    </div>

    <div class="header">
        <h1>ProfitKu: Kalender Profit Trading</h1>
        <div class="prof-header-right">
            <span id="authInfo">Guest Mode</span>
            <div class="theme-toggle" onclick="toggleTheme()">☀️</div>
        </div>
    </div>

    <div class="nav-buttons">
        <button class="btn btn-primary" onclick="prevMonth()">← Bulan Sebelumnya</button>
        <h2 id="currentMonthYear"></h2>
        <button class="btn btn-primary" onclick="nextMonth()">Bulan Berikutnya →</button>
    </div>

    <div class="calendar" id="calendar">
        </div>

    <div class="summary" id="summary">
        <h3>Ringkasan Profit Bulan Ini</h3>
        <div id="summaryContent"></div>
    </div>
    
    <div class="summary" id="exportSection">
        <h3>Ekspor & Opsi</h3>
        <button class="btn btn-secondary" id="exportBtn">Ekspor ke CSV</button>
        <button class="btn btn-danger" onclick="clearAllData()">Hapus Semua Data (Lokal)</button>
    </div>

    <div id="dataModal" class="modal" onclick="closeModal(event, 'dataModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modalTitle">Input Profit/Loss untuk </h4>
                <button class="close-btn" onclick="closeModal(null, 'dataModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="dataForm">
                    <div class="form-group">
                        <label for="inputAmount">Profit/Loss (cth: 10.50 atau -5.20):</label>
                        <input type="number" step="0.01" id="inputAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="inputCurrency">Mata Uang:</label>
                        <select id="inputCurrency" required>
                            <option value="USD">USD</option>
                            <option value="IDR">IDR</option>
                            <option value="EUR">EUR</option>
                            <option value="JPY">JPY</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inputNote">Catatan/Jurnal Trading:</label>
                        <textarea id="inputNote" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                         <label for="quickDate">Tanggal:</label>
                         <input type="date" id="quickDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteEntryBtn" style="display:none;">Hapus</button>
                <button class="btn btn-success" id="saveDataBtn">Simpan Data</button>
            </div>
        </div>
    </div>
    
    <div id="authModal" class="modal" onclick="closeModal(event, 'authModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="authModalTitle">Login atau Daftar</h4>
                <button class="close-btn" onclick="closeModal(null, 'authModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" placeholder="Email Anda" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" placeholder="Password Anda" required>
                    </div>
                    <div class="modal-footer" style="justify-content: flex-end; padding: 0;">
                        <button class="btn btn-success" onclick="loginUser()">Login</button>
                    </div>
                    <p style="text-align: center; margin-top: 10px;">Belum punya akun? <a href="#" onclick="showRegisterForm()">Daftar di sini.</a></p>
                </div>

                <div id="registerForm" class="auth-form" style="display:none;">
                    <div class="form-group">
                        <label for="registerEmail">Email:</label>
                        <input type="email" id="registerEmail" placeholder="Email Anda" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password:</label>
                        <input type="password" id="registerPassword" placeholder="Minimal 6 karakter" required>
                    </div>
                    <div class="modal-footer" style="justify-content: flex-end; padding: 0;">
                        <button class="btn btn-success" onclick="registerUser()">Daftar</button>
                    </div>
                    <p style="text-align: center; margin-top: 10px;">Sudah punya akun? <a href="#" onclick="showLoginForm()">Login di sini.</a></p>
                </div>
                
                <p id="authError" style="color: var(--danger-color); text-align: center; margin-top: 10px;"></p>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-secondary" onclick="showAboutModal()">Tentang Website & Fitur</button>
        <div class="footer-text">
            &copy; 2025 ProfitKu | Aplikasi Kalender Profit Trading Harian Gratis
        </div>
    </div>
</div>

<div id="aboutModal" class="modal" onclick="closeModal(event, 'aboutModal')">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h4>Tentang ProfitKu & Fitur Utama</h4>
            <button class="close-btn" onclick="closeModal(null, 'aboutModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p><strong>ProfitKu</strong> adalah aplikasi web kalkulator dan kalender profit trading harian gratis yang dirancang khusus untuk para trader dan investor. Kami menghilangkan kerumitan spreadsheet dan Excel dengan menyediakan antarmuka yang bersih dan interaktif.</p>
            
            <p><strong>Fitur Utama:</strong></p>
            <ul>
                <li><strong>Kalender Interaktif (Live):</strong> Catat profit atau kerugian (Loss) Anda per hari langsung di kalender.</li>
                <li><strong>Input Multi Mata Uang:</strong> Mendukung USD, IDR, EUR, JPY, GBP, dan mata uang lainnya.</li>
                <li><strong>Jurnal Trading Detail:</strong> Tambahkan catatan mendalam pada setiap entri profit/loss Anda (contoh: mengapa Anda masuk, apa yang salah/benar).</li>
                <li><strong>Ringkasan Otomatis:</strong> Kalkulasi profit/loss bulanan dan total otomatis.</li>
                <li><strong>Ekspor Data (CSV):</strong> Ekspor seluruh data profit/loss Anda untuk dianalisis lebih lanjut.</li>
                <li><strong>Penyimpanan Cloud Aman (Hanya Akun Terdaftar):</strong> Data Anda disimpan aman di database cloud (Firebase) dan hanya dapat diakses melalui akun Anda.</li>
            </ul>

            <p style="margin-top: 20px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">**Penting:** Saat ini Anda berada di Mode Demo. Data yang Anda masukkan hanya tersimpan di *browser* ini. Untuk menggunakan fitur penyimpanan cloud, riwayat permanen, dan akses multi-perangkat, silakan *Login* atau *Daftar* akun baru secara gratis.</p>
        </div>
    </div>
</div>


<script>
// --- KONFIGURASI FIREBASE ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY", // GANTI DENGAN KUNCI ANDA
    authDomain: "profitku-trade.firebaseapp.com", // GANTI DENGAN DOMAIN ANDA
    databaseURL: "https://profitku-trade-default-rtdb.asia-southeast1.firebasedatabase.app", // GANTI DENGAN DB URL ANDA
    projectId: "profitku-trade", // GANTI DENGAN PROJECT ID ANDA
};

let db, auth;
let currentUserId = null; // User ID
let isGuestMode = true; // DEFAULT: MODE DEMO

// --- GLOBAL VARIABLES & DATA HANDLING (ASLI) ---
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let allEntries = {};

// Function untuk load data (Diperbarui untuk Mode Demo/Lokal)
function loadData() {
    if (isGuestMode) {
        // Load data dari Local Storage (Mode Demo)
        try {
            const dataString = localStorage.getItem('profitku_guest_data');
            if (dataString) {
                allEntries = JSON.parse(dataString).allEntries || {};
            } else {
                allEntries = {};
            }
        } catch (e) {
            console.error("Error loading data from local storage:", e);
            allEntries = {};
        }
        renderCalendar();
    } else {
        // Load data dari Firebase (Mode Login)
        if (!currentUserId) return;
        
        const userRef = db.ref('users/' + currentUserId);
        userRef.once('value', snapshot => {
            const data = snapshot.val();
            if (data && data.allEntries) {
                allEntries = data.allEntries;
            } else {
                allEntries = {};
            }
            renderCalendar();
        }).catch(error => {
            alert('Gagal memuat data dari database: ' + error.message);
            renderCalendar();
        });
    }
}

// Function untuk menyimpan data (Diperbarui untuk Mode Demo/Lokal)
function saveData() {
    const dataToSave = {
        allEntries: allEntries
    };

    if (isGuestMode) {
        // Simpan data ke Local Storage (Mode Demo)
        try {
            localStorage.setItem('profitku_guest_data', JSON.stringify(dataToSave));
        } catch (e) {
            alert('Gagal menyimpan data ke browser Anda. Mungkin ruang penyimpanan penuh.');
        }
    } else {
        // Simpan data ke Firebase (Mode Login)
        if (!currentUserId) return;
        const userRef = db.ref('users/' + currentUserId);
        userRef.update(dataToSave)
            .then(() => {
                // Notifikasi berhasil simpan
            })
            .catch(error => {
                alert('Gagal menyimpan data ke cloud: ' + error.message);
            });
    }
}


// --- CALENDAR RENDERING LOGIC (ASLI) ---
function renderCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = ''; // Clear existing days
    const monthYearEl = document.getElementById('currentMonthYear');
    const summaryContentEl = document.getElementById('summaryContent');

    const date = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
    const firstDayIndex = date.getDay(); // 0 for Sunday, 1 for Monday

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const dayNames = ["Min", "Sen", "Sel", "Rab", "Kam", "Jum", "Sab"];

    monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

    // Render day headers
    dayNames.forEach(day => {
        const header = document.createElement('div');
        header.classList.add('day-header');
        header.textContent = day;
        calendarEl.appendChild(header);
    });

    // Render empty days
    for (let i = 0; i < firstDayIndex; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('day', 'empty');
        calendarEl.appendChild(emptyDay);
    }

    // Render actual days
    const totalProfitPerCurrency = {};
    for (let day = 1; day <= lastDay; day++) {
        const fullDate = formatYMD(currentYear, currentMonth, day);
        const dayEl = document.createElement('div');
        dayEl.classList.add('day');
        dayEl.setAttribute('data-date', fullDate);
        dayEl.onclick = () => showDataModal(fullDate);

        const numberEl = document.createElement('div');
        numberEl.classList.add('day-number');
        numberEl.textContent = day;
        dayEl.appendChild(numberEl);

        // Render profit indicators
        if (allEntries[fullDate]) {
            const dateEntries = allEntries[fullDate];
            let totalDayProfit = 0;
            let displayCount = 0;
            
            for (const currency in dateEntries) {
                const amount = dateEntries[currency].amount || 0;
                
                // Hitung total bulanan
                totalProfitPerCurrency[currency] = (totalProfitPerCurrency[currency] || 0) + amount;
                
                // Hitung total harian untuk warna
                if (currency === 'USD') { // Gunakan USD sebagai patokan utama untuk warna harian
                     totalDayProfit += amount;
                } else if (!totalDayProfit && displayCount === 0) {
                     // Jika USD 0, gunakan mata uang lain untuk warna pertama yang ditemui
                     totalDayProfit += amount;
                }
                displayCount++;

                const indicatorEl = document.createElement('div');
                indicatorEl.classList.add('profit-indicator');
                
                const formattedAmount = formatCurrency(amount, currency);
                indicatorEl.textContent = `${formattedAmount} (${currency})`;
                
                dayEl.appendChild(indicatorEl);
            }
            
            // Atur warna latar belakang berdasarkan totalDayProfit (USD atau yang pertama ditemui)
            if (totalDayProfit > 0) {
                dayEl.style.backgroundColor = 'var(--success-color, #d4edda)'; // Warna Hijau Muda
                dayEl.style.color = 'var(--text-color)';
            } else if (totalDayProfit < 0) {
                dayEl.style.backgroundColor = 'var(--danger-color, #f8d7da)'; // Warna Merah Muda
                dayEl.style.color = 'var(--text-color)';
            }
        }

        calendarEl.appendChild(dayEl);
    }

    // Render summary
    summaryContentEl.innerHTML = '';
    const sortedCurrencies = Object.keys(totalProfitPerCurrency).sort();
    
    if (sortedCurrencies.length === 0) {
        summaryContentEl.innerHTML = '<p>Belum ada entri profit/loss bulan ini.</p>';
    } else {
        sortedCurrencies.forEach(currency => {
            const total = totalProfitPerCurrency[currency];
            const className = total > 0 ? 'profit' : (total < 0 ? 'loss' : 'neutral');
            const formattedTotal = formatCurrency(total, currency);
            summaryContentEl.innerHTML += `<p>Total Profit/Loss (${currency}): <span class="${className}">${formattedTotal}</span></p>`;
        });
    }
}

// --- HELPER FUNCTIONS (ASLI) ---
function formatYMD(year, month, day) {
    const d = new Date(year, month, day);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dy = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dy}`;
}

function formatCurrency(amount, currency) {
    const absAmount = Math.abs(amount);
    let formatterOptions = { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 };

    if (currency === 'IDR') {
        formatterOptions = { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 };
    }

    const formatter = new Intl.NumberFormat('id-ID', formatterOptions);
    const formatted = formatter.format(absAmount).replace('IDR', 'Rp'); 

    return (amount < 0 ? '-' : '+') + formatted;
}

function prevMonth() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar();
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
}

// --- MODAL & FORM LOGIC (ASLI) ---
let selectedDate = null;
const dataModal = document.getElementById('dataModal');
const authModal = document.getElementById('authModal');
const aboutModal = document.getElementById('aboutModal');

function showDataModal(date) {
    selectedDate = date;
    document.getElementById('modalTitle').textContent = `Input Profit/Loss untuk ${date}`;
    document.getElementById('deleteEntryBtn').style.display = 'none';
    
    document.getElementById('dataForm').reset();
    document.getElementById('inputAmount').value = '';
    document.getElementById('inputNote').value = '';
    document.getElementById('quickDate').value = date;
    document.getElementById('inputCurrency').value = 'USD';

    if (allEntries[date]) {
        const dateEntries = allEntries[date];
        const primaryCurrency = Object.keys(dateEntries).sort()[0];
        if (dateEntries[primaryCurrency]) {
             const entry = dateEntries[primaryCurrency];
             document.getElementById('inputAmount').value = entry.amount;
             document.getElementById('inputNote').value = entry.note;
             document.getElementById('inputCurrency').value = primaryCurrency;
             document.getElementById('deleteEntryBtn').style.display = 'inline-block';
        }
    }
    
    dataModal.style.display = 'flex';
}

function showLoginModal(message = '') {
    if (currentUserId && !isGuestMode) {
        alert("Anda sudah login!");
        return;
    }
    document.getElementById('authError').textContent = message;
    showLoginForm();
    authModal.style.display = 'flex';
}

function showAboutModal() {
    aboutModal.style.display = 'flex';
}

function closeModal(event, modalId) {
    if (event && event.target.id === modalId) {
        document.getElementById(modalId).style.display = 'none';
    } else if (event === null) {
        document.getElementById(modalId).style.display = 'none';
    }
}

// --- SAVE, DELETE, AND AUTHENTICATION LOGIC (Diperbarui) ---

document.getElementById('saveDataBtn').onclick = function() {
    const amount = parseFloat(document.getElementById('inputAmount').value);
    const currency = document.getElementById('inputCurrency').value;
    const note = document.getElementById('inputNote').value;
    const dateToSave = document.getElementById('quickDate').value;
    
    if (isNaN(amount) || !dateToSave) {
        alert("Profit/Loss dan Tanggal wajib diisi.");
        return;
    }
    
    if (!allEntries[dateToSave]) {
        allEntries[dateToSave] = {};
    }

    allEntries[dateToSave][currency] = {
        amount: amount,
        note: note
    };
    
    saveData(); // Simpan ke Local Storage (jika demo) atau Firebase (jika login)
    renderCalendar();
    closeModal(null, 'dataModal');

    // Tambahkan notifikasi mode demo HANYA saat mencoba save di mode demo
    if (isGuestMode) {
        alert('Data berhasil ditambahkan ke kalender (tersimpan sementara di browser Anda). Silakan Login/Daftar untuk menyimpan permanen!');
    } else {
        alert('Data berhasil disimpan ke cloud!');
    }
};

document.getElementById('deleteEntryBtn').onclick = function() {
    if (!selectedDate) return;
    
    const currencyToDelete = document.getElementById('inputCurrency').value;
    if (allEntries[selectedDate] && allEntries[selectedDate][currencyToDelete]) {
        delete allEntries[selectedDate][currencyToDelete];
        
        if (Object.keys(allEntries[selectedDate]).length === 0) {
            delete allEntries[selectedDate];
        }
        
        saveData();
        renderCalendar();
        closeModal(null, 'dataModal');

        // Tambahkan notifikasi mode demo HANYA saat mencoba save di mode demo
        if (isGuestMode) {
             alert('Entri berhasil dihapus (tersimpan sementara di browser Anda).');
        } else {
             alert('Entri berhasil dihapus dari cloud.');
        }
    }
};

function clearAllData() {
    if (!confirm("PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA data profit/loss Anda secara permanen?")) {
        return;
    }

    allEntries = {};
    if (isGuestMode) {
        localStorage.removeItem('profitku_guest_data');
    } else {
        if (currentUserId) {
            db.ref('users/' + currentUserId).remove();
        }
    }
    
    renderCalendar();
    alert("Semua data berhasil dihapus!");
}


// --- AUTENTIKASI FIREBASE LOGIC (ASLI) ---

function showLoginForm() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('authModalTitle').textContent = 'Login';
    document.getElementById('authError').textContent = '';
}

function showRegisterForm() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('authModalTitle').textContent = 'Daftar Akun Baru';
    document.getElementById('authError').textContent = '';
}

function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    document.getElementById('authError').textContent = '';

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            closeModal(null, 'authModal');
        })
        .catch((error) => {
            let message = '';
            if (error.code === 'auth/user-not-found') {
                message = 'Pengguna tidak ditemukan. Silakan daftar atau periksa email.';
            } else if (error.code === 'auth/wrong-password') {
                message = 'Password salah.';
            } else {
                message = 'Login Gagal: ' + error.message;
            }
            document.getElementById('authError').textContent = message;
        });
}

function registerUser() {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    document.getElementById('authError').textContent = '';

    if (password.length < 6) {
        document.getElementById('authError').textContent = 'Password minimal 6 karakter.';
        return;
    }

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            closeModal(null, 'authModal');
        })
        .catch((error) => {
            let message = '';
            if (error.code === 'auth/email-already-in-use') {
                message = 'Email ini sudah terdaftar. Silakan Login.';
            } else {
                 message = 'Daftar Gagal: ' + error.message;
            }
            document.getElementById('authError').textContent = message;
        });
}

function logoutUser() {
    auth.signOut().then(() => {
        // Handled by onAuthStateChanged
    }).catch((error) => {
        alert('Logout Gagal: ' + error.message);
    });
}

// --- AUTH STATE LISTENER (MODE DEMO TOGGLE) ---
function handleAuthStatus(user) {
    const authInfoEl = document.getElementById('authInfo');
    const authStatusAlertEl = document.getElementById('authStatusAlert');

    if (user) {
        // USER LOGGED IN
        currentUserId = user.uid;
        isGuestMode = false;
        authInfoEl.innerHTML = `<a href="#" onclick="logoutUser()" class="btn btn-secondary">Logout</a>`;
        authStatusAlertEl.style.backgroundColor = 'var(--success-color)';
        authStatusAlertEl.innerHTML = `Selamat datang, ${user.email}! Data Anda sekarang tersimpan di Cloud.`;
        loadData(); // Load data dari Firebase
    } else {
        // USER LOGGED OUT / GUEST MODE
        currentUserId = null;
        isGuestMode = true;
        authInfoEl.innerHTML = `<a href="#" onclick="showLoginModal()" class="btn btn-primary">Login / Daftar</a>`;
        authStatusAlertEl.style.backgroundColor = 'var(--danger-color)';
        authStatusAlertEl.innerHTML = `Anda berada di **Mode Demo** (data tidak disimpan permanen). Silakan <a href="#" onclick="showLoginModal()" style="color: yellow; text-decoration: underline;">**LOGIN/DAFTAR**</a> untuk menyimpan data Anda!`;
        loadData(); // Load data dari Local Storage
    }
}


// --- THEME TOGGLE (ASLI) ---
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '🌙' : '☀️';
}

// --- INITIALIZATION (Diperbarui) ---
function initializeApp() {
    // 1. Inisialisasi Firebase (Harus dijalankan di awal)
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.database();
    auth = firebase.auth();

    // 2. Terapkan tema yang tersimpan
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '🌙' : '☀️';

    // 3. Listener status autentikasi untuk menentukan Mode Demo
    auth.onAuthStateChanged(handleAuthStatus);
    
    // 4. Set tanggal cepat
    const today = new Date();
    const quickDate = document.getElementById('quickDate');
    if(quickDate) quickDate.value = formatYMD(today.getFullYear(),today.getMonth(),today.getDate());
    
    // 5. Event listener untuk tombol Ekspor
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
}

window.onload = initializeApp;

// --- EXPORT TO CSV LOGIC (ASLI) ---
function exportToCSV() {
    const data = { allEntries: allEntries };
    
    const rows = [['Tanggal', 'Jumlah', 'Mata Uang', 'Catatan']];
    const totalProfitPerCurrency = {};
    
    for (const date of Object.keys(data.allEntries).sort()) {
        const dateEntries = data.allEntries[date];
        
        for (const currency in dateEntries) {
            const entry = dateEntries[currency];
            const amount = entry.amount || 0;
            const note = entry.note.replace(/,/g, ';').replace(/\\n/g, ' '); 
            
            rows.push([date, String(amount), currency, note]); 
            
            totalProfitPerCurrency[currency] = (totalProfitPerCurrency[currency] || 0) + amount;
        }
    }
    
    rows.push(['---', '---', '---', '---']); 
    for (const currency of Object.keys(totalProfitPerCurrency).sort()) {
        const total = totalProfitPerCurrency[currency];
        const totalLabel = (total < 0) ? `Total Loss (${currency})` : `Total Profit (${currency})`;
        const displayTotal = total.toFixed(2); 
        rows.push([totalLabel, String(displayTotal), currency, '']);
    }
    
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    
    const a=document.createElement('a'); a.href=url; a.download=`profit_calendar_multi_currency_export.csv`; a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
